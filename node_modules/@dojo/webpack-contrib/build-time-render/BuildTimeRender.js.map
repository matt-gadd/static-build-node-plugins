{"version":3,"file":"BuildTimeRender.js","sourceRoot":"","sources":["BuildTimeRender.ts"],"names":[],"mappings":"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","sourcesContent":["import { Compiler } from 'webpack';\nimport { readFileSync, outputFileSync, existsSync } from 'fs-extra';\n\nimport { join } from 'path';\nimport {\n\tserve,\n\tnavigate,\n\tgetClasses,\n\tgetPrefix,\n\tgenerateBasePath,\n\tgenerateRouteInjectionScript,\n\tgetForSelector,\n\tsetHasFlags\n} from './helpers';\nconst filterCss = require('filter-css');\nconst puppeteer = require('puppeteer');\n\nexport interface RenderResult {\n\tpath?: string | BuildTimePath;\n\thtml: string;\n\tstyles: string;\n\tscript: string;\n}\n\nexport interface BuildTimePath {\n\tpath: string;\n\tmatch: string[];\n}\n\nexport interface BuildTimeRenderArguments {\n\troot: string;\n\tentries: string[];\n\tuseManifest?: boolean;\n\tpaths?: (BuildTimePath | string)[];\n\tuseHistory?: boolean;\n\tpuppeteerOptions?: any;\n}\n\nexport default class BuildTimeRender {\n\tprivate _cssFiles: string[] = [];\n\tprivate _entries: string[];\n\tprivate _head: string;\n\tprivate _inlinedCssClassNames: string[] = [];\n\tprivate _manifest: any;\n\tprivate _output?: string;\n\tprivate _paths: any[];\n\tprivate _puppeteerOptions: any;\n\tprivate _root: string;\n\tprivate _useHistory = false;\n\tprivate _useManifest: boolean;\n\n\tconstructor(args: BuildTimeRenderArguments) {\n\t\tconst { paths = [], root = '', useManifest = false, entries, useHistory, puppeteerOptions } = args;\n\t\tconst path = paths[0];\n\t\tconst initialPath = typeof path === 'object' ? path.path : path;\n\n\t\tthis._puppeteerOptions = puppeteerOptions;\n\t\tthis._paths = paths;\n\t\tthis._root = root;\n\t\tthis._useManifest = useManifest;\n\t\tthis._entries = entries.map((entry) => `${entry.replace('.js', '')}.js`);\n\t\tthis._manifest = this._entries.reduce(\n\t\t\t(manifest, entry) => {\n\t\t\t\tmanifest[entry] = entry;\n\t\t\t\treturn manifest;\n\t\t\t},\n\t\t\t{} as any\n\t\t);\n\t\tthis._useHistory = useHistory !== undefined ? useHistory : paths.length > 0 && !/^#.*/.test(initialPath);\n\t}\n\n\tprivate _writeIndexHtml({ html, script, path = '', styles }: RenderResult) {\n\t\tpath = typeof path === 'object' ? path.path : path;\n\t\tconst prefix = getPrefix(path);\n\t\tif (this._head) {\n\t\t\tconst head = this._head.replace(/href=\"(?!(http(s)?|\\/))(.*?)\"/g, `href=\"${prefix}$3\"`);\n\t\t\thtml = html.replace(/<head>([\\s\\S]*?)<\\/head>/gm, head);\n\t\t}\n\t\tconst css = this._cssFiles.reduce((css, entry: string | undefined) => {\n\t\t\thtml = html.replace(`<link href=\"${prefix}${entry}\" rel=\"stylesheet\">`, `<style>${styles}</style>`);\n\t\t\tcss = `${css}<link rel=\"stylesheet\" href=\"${prefix}${entry}\" media=\"none\" onload=\"if(media!='all')media='all'\" />`;\n\t\t\treturn css;\n\t\t}, '');\n\n\t\thtml = html.replace(/^(\\s*)(\\r\\n?|\\n)/gm, '').trim();\n\t\thtml = html.replace(this._createScripts(path), `${script}${css}${this._createScripts(path)}`);\n\t\toutputFileSync(join(this._output!, ...path.split('/'), 'index.html'), html);\n\t}\n\n\tprivate _createScripts(path = '') {\n\t\tconst prefix = this._useHistory ? getPrefix(path) : '';\n\t\treturn this._entries.reduce(\n\t\t\t(script, entry) =>\n\t\t\t\t`${script}<script type=\"text/javascript\" src=\"${prefix}${this._manifest[entry]}\"></script>`,\n\t\t\t''\n\t\t);\n\t}\n\n\tprivate _filterCss(classes: string[]): string {\n\t\treturn this._cssFiles.reduce((result, entry: string) => {\n\t\t\tlet filteredCss: string = filterCss(join(this._output!, entry), (context: string, value: string) => {\n\t\t\t\tif (context === 'selector') {\n\t\t\t\t\tvalue = value.replace(/(:| ).*/, '');\n\t\t\t\t\tvalue = value\n\t\t\t\t\t\t.split('.')\n\t\t\t\t\t\t.slice(0, 2)\n\t\t\t\t\t\t.join('.');\n\t\t\t\t\tconst firstChar = value.substr(0, 1);\n\t\t\t\t\tif (!this._useHistory && this._inlinedCssClassNames.indexOf(value) !== -1) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tif (classes.indexOf(value) !== -1 || ['.', '#'].indexOf(firstChar) === -1) {\n\t\t\t\t\t\tthis._inlinedCssClassNames.push(value);\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tfilteredCss = filteredCss\n\t\t\t\t.replace(/\\/\\*.*\\*\\//g, '')\n\t\t\t\t.replace(/^(\\s*)(\\r\\n?|\\n)/gm, '')\n\t\t\t\t.trim();\n\t\t\tresult = `${result}${filteredCss}`;\n\t\t\treturn result;\n\t\t}, '');\n\t}\n\n\tprivate async _getRenderResult(\n\t\tpage: any,\n\t\tpath: BuildTimePath | string | undefined = undefined,\n\t\tallContents = true\n\t): Promise<RenderResult> {\n\t\tconst classes: any[] = await getClasses(page);\n\t\tlet pathValue = typeof path === 'object' ? path.path : path;\n\t\tlet html = allContents ? await page.content() : await getForSelector(page, `#${this._root}`);\n\t\tlet styles = this._filterCss(classes);\n\t\tlet script = '';\n\t\thtml = html.replace(/http:\\/\\/localhost:\\d+\\//g, '');\n\t\tif (this._useHistory) {\n\t\t\tstyles = styles.replace(/url\\(\"(?!(http(s)?|\\/))(.*?)\"/g, `url(\"${getPrefix(pathValue)}$3\"`);\n\t\t\thtml = html.replace(/src=\"(?!(http(s)?|\\/))(.*?)\"/g, `src=\"${getPrefix(pathValue)}$3\"`);\n\t\t\tscript = generateBasePath(pathValue);\n\t\t}\n\t\treturn { html, styles, script, path };\n\t}\n\n\tpublic apply(compiler: Compiler) {\n\t\tif (!this._root) {\n\t\t\treturn;\n\t\t}\n\t\tcompiler.hooks.afterEmit.tapAsync(this.constructor.name, async (compilation, callback) => {\n\t\t\tthis._output = compiler.options.output && compiler.options.output.path;\n\t\t\tif (!this._output) {\n\t\t\t\treturn Promise.resolve().then(() => {\n\t\t\t\t\tcallback();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (this._useManifest) {\n\t\t\t\tthis._manifest = JSON.parse(readFileSync(join(this._output, 'manifest.json'), 'utf-8'));\n\t\t\t}\n\n\t\t\tlet originalIndexHtml = readFileSync(join(this._output, 'index.html'), 'utf-8');\n\t\t\tconst matchingHead = /<head>([\\s\\S]*?)<\\/head>/.exec(originalIndexHtml);\n\t\t\tif (matchingHead) {\n\t\t\t\tthis._head = matchingHead[0];\n\t\t\t}\n\t\t\tthis._cssFiles = this._entries.reduce(\n\t\t\t\t(files, entry) => {\n\t\t\t\t\tconst fileName = this._manifest[entry.replace('.js', '.css')] || entry.replace('.js', '.css');\n\t\t\t\t\tconst exists = existsSync(join(this._output!, fileName));\n\t\t\t\t\tif (exists) {\n\t\t\t\t\t\tfiles.push(fileName);\n\t\t\t\t\t}\n\t\t\t\t\treturn files;\n\t\t\t\t},\n\t\t\t\t[] as string[]\n\t\t\t);\n\n\t\t\tconst browser = await puppeteer.launch(this._puppeteerOptions);\n\t\t\tconst app = await serve(`${this._output}`);\n\t\t\ttry {\n\t\t\t\tconst page = await browser.newPage();\n\t\t\t\tawait setHasFlags(page);\n\t\t\t\tconst wait = page.waitForNavigation({ waitUntil: 'networkidle0' });\n\t\t\t\tawait page.goto(`http://localhost:${app.port}/`);\n\t\t\t\tawait wait;\n\n\t\t\t\tif (this._paths.length === 0) {\n\t\t\t\t\tconst result = await this._getRenderResult(page, undefined);\n\t\t\t\t\tthis._writeIndexHtml(result);\n\t\t\t\t} else {\n\t\t\t\t\tlet renderResults: RenderResult[] = [];\n\t\t\t\t\trenderResults.push(await this._getRenderResult(page, undefined, this._useHistory));\n\n\t\t\t\t\tfor (let i = 0; i < this._paths.length; i++) {\n\t\t\t\t\t\tlet path = typeof this._paths[i] === 'object' ? this._paths[i].path : this._paths[i];\n\t\t\t\t\t\tawait navigate(page, this._useHistory, path);\n\t\t\t\t\t\tlet result = await this._getRenderResult(page, this._paths[i], this._useHistory);\n\t\t\t\t\t\trenderResults.push(result);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this._useHistory) {\n\t\t\t\t\t\trenderResults.forEach((result) => {\n\t\t\t\t\t\t\tthis._writeIndexHtml(result);\n\t\t\t\t\t\t});\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst combined = renderResults.reduce(\n\t\t\t\t\t\t\t(combined, result) => {\n\t\t\t\t\t\t\t\tcombined.styles = result.styles\n\t\t\t\t\t\t\t\t\t? `${combined.styles}\\n${result.styles}`\n\t\t\t\t\t\t\t\t\t: combined.styles;\n\t\t\t\t\t\t\t\tcombined.html.push(result.html);\n\t\t\t\t\t\t\t\tcombined.paths.push(result.path || '');\n\t\t\t\t\t\t\t\treturn combined;\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{ styles: '', html: [], paths: [] } as {\n\t\t\t\t\t\t\t\tpaths: (string | BuildTimePath)[];\n\t\t\t\t\t\t\t\tstyles: string;\n\t\t\t\t\t\t\t\thtml: string[];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t);\n\t\t\t\t\t\tlet html = readFileSync(join(this._output, 'index.html'), 'utf-8');\n\t\t\t\t\t\tconst script = generateRouteInjectionScript(combined.html, combined.paths, this._root);\n\t\t\t\t\t\tthis._writeIndexHtml({ styles: combined.styles, html, script });\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tthrow error;\n\t\t\t} finally {\n\t\t\t\tawait browser.close();\n\t\t\t\tawait app.server.close();\n\t\t\t\tcallback();\n\t\t\t}\n\t\t});\n\t}\n}\n"]}